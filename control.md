# 显示板指令类型

> BLE 和显示板使用相同的指令定义。

## 协议版本

- TT01 协议版本：**0x02**

## 显示类指令

| 指令                     | 编号 | 请求下发数据 | 响应上传数据                     |
| ------------------------ | ---- | ------------ | -------------------------------- |
| 连接请求                 | 0x10 | 协议版本     | 型号、固件版本、硬件版本、序列号 |
| 电量百分比和充电状态请求 | 0x30 | 无           | 电量百分比，充电状态             |
| 电压和电流请求           | 0x36 | 无           | 电压，电流                       |
| 机器状态请求             | 0x37 | 无           | 机器状态（错误码）               |
| 功能模式请求             | 0x3D | 无           | 功能模式                         |
| 速度档位请求             | 0x3E | 无           | 速度档位                         |

## 控制类指令

| 指令          | 编号 | 请求下发数据                                       | 响应上传数据 |
| ------------- | ---- | -------------------------------------------------- | ------------ |
| 速度控制      | 0x41 | 线速度，角速度                                     | 无           |
| 推杆控制      | 0x42 | 推杆 A 速度，推杆 B 速度，推杆 C 速度，推杆 D 速度 | 无           |
| 功能模式控制  | 0x4D | 模式定义                                           | 无           |
| 速度档位控制  | 0x4E | 档位定义                                           | 无           |
| 摇杆控制      | 0x81 | X 轴偏量，Y 轴偏量                                 | 无           |
| 折叠/展开控制 | 0x82 | 折叠展开行为定义                                   | 无           |

## DFU

参考：[Control Bus 协议](http://10.10.99.95:8083/doc-wiki#/page/show?pageId=260)

# 指令定义

## 显示类

### 连接请求（0x10）

- 指令编号：**0x10**
- 请求数据：协议版本**u8**

| Cmd                | CbCmd           | 协议版本              |
| ------------------ | --------------- | --------------------- |
| 0xF8 (Control Bus) | 0x10 (连接请求) | 0x02（TT01 协议版本） |

- 应答数据：型号**u8[12]**、固件版本**u16**、硬件版本**u16**、序列号**u32[3]**

| Cmd       | 型号   | 固件版本 | 硬件版本 | 序列号 |
| --------- | ------ | -------- | -------- | ------ |
| 0x02 (OK) | u8[12] | u16      | u16      | u32[3] |

示例：

```
Req: 0x50 0x03 0x00 0xF8 0x10 0x02 XOR8
Res: 0x50 0x1C 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 XOR8
```

#### 固件版本的定义

固件版本形如：MAJOR.MINOR.REVISION

例如：

```
1.3.0
```

这里使用 MAJOR << 8 | MINOR << 4 | REVISION，形成一个固件版本号。

- MAJOR：0-255
- MINOR：0-15
- REVISION：0-15

### 电量和充电状态请求（0x30）

- 指令编号：**0x30**
- 请求数据：无
- 应答数据：电量百分比（0 ～ 100）**u8**，充电状态**u8**

| Cmd       | 电量百分比（0 ～ 100） | 充电状态 |
| --------- | ---------------------- | -------- |
| 0x02 (OK) | u8                     | u8       |

示例：

```
Req: 0x50 0x02 0x00 0xF8 0x30 XOR8
Res: 0x50 0x02 0x00 0x02 0x00 XOR8
```

#### 充电状态定义

按位表示充电状态。
|0|1|2|3|4|5|6|7|
|-|-|-|-|-|-|-|-|
|是否充电|是否插电|~~是否锁定充电桩~~|~~是否探测到充电桩~~|~~是否通讯上充电桩~~|~~是否在和充电桩协商~~|预留|预留|

举例说明：

- 不在充电：0x00
- 在充电：0x03
- 充满：两种判断逻辑
  - 0x02（如果充满后电池不再充电）
  - 根据电量判断

### 电压和电流请求（0x36）

- 指令编号：**0x36**
- 请求数据：无
- 应答数据：电压（mV）**s32**，电流（mA）**s32**

| Cmd       | 电压（mV） | 电流（mA） |
| --------- | ---------- | ---------- |
| 0x02 (OK) | s32        | s32        |

示例：

```
Req: 0x50 0x02 0x00 0xF8 0x36 XOR8
Res: 0x50 0x08 0x00 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 XOR8
```

### 机器状态请求（0x37）

- 指令编号：**0x37**
- 请求数据：无
- 应答数据：机器状态**u8**，错误码**u32**

| Cmd       | 机器状态 | 错误码 |
| --------- | -------- | ------ |
| 0x02 (OK) | u8       | u32    |

示例：

```
Req: 0x50 0x02 0x00 0xF8 0x37 XOR8
Res: 0x50 0x05 0x00 0x02 0x00 0x00 0x00 0x00 0x00 XOR8
```

#### 机器状态的定义（错误码）

- TODO

### 功能模式请求（0x3D）

- 指令编号：**0x3D**
- 请求数据：无
- 应答数据：功能模式**u8**

| Cmd       | 功能模式 |
| --------- | -------- |
| 0x02 (OK) | u8       |

示例：

```
Req: 0x50 0x02 0x00 0xF8 0x3D XOR8
Res: 0x50 0x02 0x00 0x02 0x00 XOR8
```

#### 功能模式的定义

- 手动模式：0x00
- 自平衡模式：0x01

### 速度档位请求（0x3E）

- 指令编号：**0x3E**
- 请求数据：无
- 应答数据：速度档位**u8**

| Cmd       | 速度档位 |
| --------- | -------- |
| 0x02 (OK) | u8       |

示例：

```
Req: 0x50 0x02 0x00 0xF8 0x3E XOR8
Res: 0x50 0x02 0x00 0x02 0x00 XOR8
```

#### 速度档位的定义

- 0 档：0x00
- 1 档：0x01
- 2 档：0x02
- 3 档：0x03
- 4 档：0x04
- 5 档：0x05

## 控制类

### 速度控制（0x41）

- 指令编号：**0x41**
- 请求数据：线速度（m/s）**float**，角速度（r/s）**float**

| Cmd                | CbCmd           | 线速度（m/s） | 角速度（r/s） |
| ------------------ | --------------- | ------------- | ------------- |
| 0xF8 (Control Bus) | 0x41 (速度控制) | float         | float         |

- 应答数据：无

示例：

```
Req: 0x50 0x0A 0x00 0xF8 0x41 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 XOR8
Res: 0x50 0x01 0x00 0x02 XOR8
```

### 推杆控制（0x42）

- 指令编号：**0x42**
- 请求数据：推杆 A 速度**s32**，推杆 B 速度**s32**，推杆 C 速度**s32**，推杆 D 速度**s32**

| Cmd                | CbCmd           | 推杆 A 速度 | 推杆 B 速度 | 推杆 C 速度 | 推杆 D 速度 |
| ------------------ | --------------- | ----------- | ----------- | ----------- | ----------- |
| 0xF8 (Control Bus) | 0x42 (推杆控制) | s32         | s32         | s32         | s32         |

- 应答数据：无

示例：

```
Req: 0x50 0x12 0x00 0xF8 0x42 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 XOR8
Res: 0x50 0x01 0x00 0x02 XOR8
```

### 功能模式控制（0x4D）

- 指令编号：**0x4D**
- 请求数据：功能模式 **u8**

| Cmd                | CbCmd               | 功能模式 |
| ------------------ | ------------------- | -------- |
| 0xF8 (Control Bus) | 0x4D (功能模式控制) | u8       |

- 应答数据：无

示例：

```
Req: 0x50 0x03 0x00 0xF8 0x4D 0x00 XOR8
Res: 0x50 0x01 0x00 0x02 XOR8
```

### 速度档位控制（0x4E）

- 指令编号：**0x4E**
- 请求数据：速度档位 **u8**

| Cmd                | CbCmd               | 速度档位 |
| ------------------ | ------------------- | -------- |
| 0xF8 (Control Bus) | 0x4E (速度档位控制) | u8       |

- 应答数据：无

示例：

```
Req: 0x50 0x03 0x00 0xF8 0x4E 0x00 XOR8
Res: 0x50 0x01 0x00 0x02 XOR8
```

### 摇杆控制（0x81）

- 指令编号：**0x81**
- 请求数据：X 轴偏量**s16**，Y 轴偏量**s16**，Z 轴偏量**s16**

| Cmd                | CbCmd           | X 轴偏量 | Y 轴偏量 | Z 轴偏量 |
| ------------------ | --------------- | -------- | -------- | -------- |
| 0xF8 (Control Bus) | 0x81 (摇杆控制) | s16      | s16      | s16      |

> 偏移量取值范围：[-100, 100]。
> 数值代表百分比，正负代表方向。
> X 轴为前后方向，正为前，负为后。
> Y 轴为左右方向，正为左，负为右。
> Z 轴预留。

- 应答数据：无

示例：

```
Req: 0x50 0x08 0x00 0xF8 0x81 0x00 0x00 0x00 0x00 0x00 0x00 XOR8
Res: 0x50 0x01 0x00 0x02 XOR8
```

### 折叠/展开控制（0x82）

- 指令编号：**0x82**
- 请求数据：0x00 (折叠)/0x01 (展开)

| Cmd                | CbCmd                | 折叠/展开控制           |
| ------------------ | -------------------- | ----------------------- |
| 0xF8 (Control Bus) | 0x82 (折叠/展开控制) | 0x00 (折叠)/0x01 (展开) |

- 应答数据：无

示例：

```
Req: 0x50 0x03 0x00 0xF8 0x82 0x00 XOR8
Res: 0x50 0x01 0x00 0x02 XOR8
```
