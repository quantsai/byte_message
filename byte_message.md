# byte message 协议

## inter-chip 通讯协议

inter-chip 数据包格式：
|Flag|Len|LenH|Cmd|Payload|Checksum|
|-|-|-|-|-|-|
|u8|u8|u8|u8|u8[n]|u8|

### Flag 字段

| 字段名 | 字段长度 | 字段作用                   |
| ------ | -------- | -------------------------- |
| Flag   | u8       | 定义本数据包的具体解释方式 |

Flag 字段占用一个字节。随着其各标志位的不同，对其后的数据包有不同的定义。

Flag 中的标志位：
|标志位数|7|6|5|4|3|2|1|0|
|-|-|-|-|-|-|-|-|-|
|Flag 中每个 bit 的作用|reserve|LongFrame|reserve|ChecksumEnable|reserve|reserve|reserve|reserve|

Flag 中各标志位的具体解释：
|标志位名|描述|
|-|-|
|LongFrame|为 1 时，启用 LenH 字段。关闭时，长度为 1B，最多 255。开启时，长度为 2B，最多 65535。|
|ChecksumEnable|为 1 时，启用 Checksum 字段。通常打开。|

通常包头存在两种形式：
|LongFrame 关闭时|LongFrame 开启时|
|-|-|
|0x10|0x50|

### Len 和 LenH 字段

| 字段名 | 字段长度 | 字段作用                                                     |
| ------ | -------- | ------------------------------------------------------------ |
| Len    | u8       | 数据包装载数据的长度信息的低位，高位不启用时最大可以表示 255 |
| LenH   | u8       | 数据包装载数据的长度信息的高位，结合 Len 最大可以表示 65535  |

Len 和 LenH 各占用一个字节。LongFrame 为 0 时,数据包没有 LenH 字段。LongFrame 为 1 时,启用 LenH 字段。其表示 Payload 字段和 Cmd 字段的长度总和，即：

> Len=n+1

### Cmd 字段

| 字段名 | 字段长度 | 字段作用                                                                       |
| ------ | -------- | ------------------------------------------------------------------------------ |
| Cmd    | u8       | 表示发送方或者接收方应该对数据包执行的操作命令，预留 0x00-0x0F，其他可自定义。 |

通讯时，数据的发送方将请求作为数据包发送给接收方，而接收方在处理请求后将应答作为数据包送还给发送方。如此便完成了一次通讯。

#### 请求包 Cmd

当数据包作为请求包时，Cmd 表示如下含义：
|预留的 Cmd 取值|描述|
|-|-|
|0x00|进行强制同步|
|0x01|测试接收方通讯状况|
|0x02-0x0F|预留|

#### 应答包 Cmd

当数据包作为应答包时，Cmd 表示如下含义：
|预留的 Cmd 取值|描述|
|-|-|
|0x00|强制同步的应答|
|0x01|测试通讯的应答|
|0x02|OK，表示上一个请求被正确执行|
|0x03|Error，表示上一个请求在执行时出现问题|
|0xFF|Invaild，表示请求包不完整或者结构不正确|

### Payload 字段

| 字段名  | 字段长度 | 字段作用 |
| ------- | -------- | -------- |
| Payload | u8[n]    | 数据负载 |

当数据包作为请求包时，Payload 装载了数据的发送方发送给接收方的数据。

当数据包作为应答包时：

- 如果 Cmd 为 0x02（OK），则 Payload 根据自定义协议装载数据。
- 如果 Cmd 为 0x03（Error）或 0xFF（Invaild），则 Payload 装载一个错误码。

| 错误码 | 描述                           |
| ------ | ------------------------------ |
| 0x40   | 请求包的校验和不匹配           |
| 0x20   | 请求包的长度超过缓冲区承受范围 |
| 0x10   | 没有同接收方完成同步           |
| 0x8000 | 请求包中的 Cmd 不被接收方支持  |
| 0x8001 | 请求包在执行中遇到格式类错误   |
| 0x8002 | 请求包在执行中遇到操作类错误   |

### Checksum 字段

| 字段名   | 字段长度 | 字段作用                     |
| -------- | -------- | ---------------------------- |
| Checksum | u8       | 数据包中，所有字节的异或之和 |

Checksum 是数据包中，自身之前所有字节进行异或求和后的结果，即：

> Checksum=pkg[0] xor pkg[1] xor pkg[2] xor ... xor pkg[n-2]

## control bus控制指令

本身使用 inter-chip 通讯协议的扩展模式，定义了 inter-chip 协议中 Cmd 字段的自定义命令，0xF8。

根据数据包长度分为两种格式：
|Flag|Len|Cmd|_CbCmd_|_CbPayload_|Checksum|
|-|-|-|-|-|-|
|0x50|u16|0xF8|u8|u8[n]|u8|

| Flag | Len | Cmd  | _CbCmd_ | _CbPayload_ | Checksum |
| ---- | --- | ---- | ------- | ----------- | -------- |
| 0x10 | u8  | 0xF8 | u8      | u8[n]       | u8       |

### 控制指令 请求命令列表

控制指令协议定义了一系列请求命令：

| 请求命令     | 命令代码 | 描述                                           |
| ------------ | -------- | ---------------------------------------------- |
| 连接请求     | 0x10     | 请求连接，接收方会返回硬件、固件版本信息       |
| 状态请求     | 0x30     | 请求获取接收方的状态，包括电池电量、充电状态等 |
| 轮组数据请求 | 0x31     | 请求接收方的里程计数据                         |

### 连接请求（0x10）

#### 请求包 Payload
 
 
 
 
 、、
 | CbCmd | 协议版本 |
| ----- | -------- |
| 0x10  | u8       |

#### 应答包 Payload

| Cmd       | 型号   | 固件版本 | 硬件版本 | 序列号 |
| --------- | ------ | -------- | -------- | ------ |
| 0x20 (OK) | u8[12] | u16      | u16      | u32[3] |

### 状态请求（0x30）

#### 请求包 Payload

| CbCmd |
| ----- |
| 0x30  |

#### 应答包 Payload

| Cmd       | 电量百分比 | 充电状态 |
| --------- | ---------- | -------- |
| 0x20 (OK) | u8         | u8       |

### 轮组数据请求（0x31）

#### 请求包 Payload

| CbCmd |
| ----- |
| 0x31  |

#### 应答包 Payload

| Cmd       | 左轮累计里程 | 右轮累计里程 |
| --------- | ------------ | ------------ |
| 0x20 (OK) | s32          | s32          |

## DFU 相关指令

在设备 dfu 时，系统定义了一套交互指令，用于开启和结束升级过程，以及接受升级数据。

定义 inter-chip 协议中 Cmd 字段为 0x20。

根据数据包长度分为两种格式：
|Flag|Len|Cmd|_DfuCmd_|_DfuVersion_|_DfuPayload_|Checksum|
|-|-|-|-|-|-|-|
|0x50|u16|0x20|u8|0x01|u8[n]|u8|

| Flag | Len | Cmd  | _DfuCmd_ | _DfuVersion_ | _DfuPayload_ | Checksum |
| ---- | --- | ---- | -------- | ------------ | ------------ | -------- |
| 0x10 | u8  | 0x20 | u8       | 0x01         | u8[n]        | u8       |

> 当前支持的最新版本为 0x01 。

### DFU 指令列表

| 请求命令     | 命令代码 | 描述                          |
| ------------ | -------- | ----------------------------- |
| 获取设备信息 | 0x01     | 返回设备关于升级的一系列信息  |
| 开始升级     | 0x02     | 初始化升级过程                |
| 完成升级     | 0x03     | 完成升级过程并进入 bootloader |
| Run          | 0x04     |                               |
| 写升级包     | 0x05     | 将一个片段写入 flash          |
| 批量写升级包 | 0x07     | 批量写入 flash                |

### 获取设备信息（0x01）

#### 请求包 Payload

| DfuCmd | DfuVersion | DfuPayload |
| ------ | ---------- | ---------- |
| 0x01   | 0x01       | NULL       |

#### 应答包 Payload

| Cmd       | DfuPkgVersion | BootloaderVersion | BootloaderPageCnt | DeviceType | PageNum | PageSize | RomVersion | VenderInfo | HardwareVersion | DfuDeviceFlag | DfuDevicePowerVolt |
| --------- | ------------- | ----------------- | ----------------- | ---------- | ------- | -------- | ---------- | ---------- | --------------- | ------------- | ------------------ |
| 0x02 (OK) | u8            | u16               | u16               | u16        | u32     | u32      | u32        | u32        | u16             | u32           | u32                |

### 开始升级（0x02）

#### 请求包 Payload

| DfuCmd | DfuVersion | DfuPayload |
| ------ | ---------- | ---------- |
| 0x02   | 0x01       | NULL       |

#### 应答包 Payload

| Cmd       | DfuPkgVersion | DfuOpResult |
| --------- | ------------- | ----------- |
| 0x02 (OK) | u8            | 0x00 (OK)   |

### 完成升级（0x03）

#### 请求包 Payload

| DfuCmd | DfuVersion | DfuPayload |
| ------ | ---------- | ---------- |
| 0x03   | 0x01       | NULL       |

#### 应答包 Payload

| Cmd       | DfuPkgVersion | DfuOpResult |
| --------- | ------------- | ----------- |
| 0x02 (OK) | u8            | 0x00 (OK)   |

### 写升级包（0x05）

#### 请求包 Payload

| DfuCmd | DfuVersion | DfuBlob         |
| ------ | ---------- | --------------- |
| 0x05   | 0x01       | sizeof(DfuBlob) |

##### DfuBlob

| PageId | BlobId | BlobSize | BlobStart | BlobData |
| ------ | ------ | -------- | --------- | -------- |
| u16    | u16    | u16      | u16       | u8[n]    |

#### 应答包 Payload

| Cmd       | DfuPkgVersion | DfuOpResult                   |
| --------- | ------------- | ----------------------------- |
| 0x02 (OK) | u8            | 0x00 (OK)/0x01 (Incompatible) |

### 批量写升级包（0x07）

#### 请求包 Payload

| DfuCmd | DfuVersion | DfuBlobList         |
| ------ | ---------- | ------------------- |
| 0x07   | 0x01       | sizeof(DfuBlobList) |

##### DfuBlobList

| BlobCnt | DfuBlob \* n         |
| ------- | -------------------- |
| u8      | sizeof(DfuBlob) \* n |

#### 应答包 Payload

| Cmd       | DfuPkgVersion | DfuOpResult                   |
| --------- | ------------- | ----------------------------- |
| 0x02 (OK) | u8            | 0x00 (OK)/0x01 (Incompatible) |
